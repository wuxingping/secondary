{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\caoxue\\\\Desktop\\\\secondary\\\\secondary\\\\src\\\\pages\\\\message\\\\messageDetail.js\";\n\n/**\r\n * Created by Lenovo on 2019/9/2.\r\n */\nimport React from 'react';\nimport './message.css';\nimport avatar from '../../images/personal/avatar.jpg';\nimport sale from '../../images/personal/sale.png';\nimport buy from '../../images/personal/buy.png';\nimport modify from '../../images/personal/modify.png';\nimport { Title } from '../../share';\nimport { getData, goNext, getTimeFormat, getTimeHour } from '../../utils';\nlet self;\nexport default class MessageDetail extends React.Component {\n  constructor(props) {\n    super(props);\n    this.item = this.props.history.location.state || {};\n    console.log(this.item);\n    self = this;\n    this.count = 0;\n    this.state = {\n      chatList: [],\n      index: 0,\n      value: null,\n      isShow: false\n    };\n    var item = this.props.history.location.state || {};\n    this.item = item;\n    console.log(item);\n  }\n\n  componentDidMount() {\n    this.getChatDetailList();\n    var textarea = document.getElementsByTagName(\"textarea\");\n\n    for (var i = 0; i < textarea.length; i++) {\n      textarea[i].style.height = '0.5rem';\n      textarea[i].scrollTop = 0; //防抖动\n\n      textarea[i].style.height = textarea[i].scrollHeight + 'px';\n      textarea[i].addEventListener('input', function (e) {\n        e.target.style.height = 'auto';\n        e.target.scrollTop = 0; //防抖动\n\n        if (e.target.scrollHeight < 20) {\n          e.target.style.height = '20px';\n        } else {\n          e.target.style.height = e.target.scrollHeight + 'px';\n        }\n      });\n    }\n\n    var user = JSON.parse(localStorage.getItem(\"userInfo\")) || {};\n    var userId = user.userId;\n    console.log(user);\n    this.socket = new WebSocket(\"ws://49.232.24.206:9001/secondary/socket?\" + userId); //心跳检测\n\n    this.heartCheck = {\n      timeout: 60000,\n      //心跳间隔时间，单位ms\n      timeoutObj: null,\n      serverTimeoutObj: null,\n      reset: function () {\n        clearTimeout(this.timeoutObj);\n        clearTimeout(this.serverTimeoutObj);\n        return this;\n      },\n      start: function () {// var self = this;\n        // this.timeoutObj = setTimeout(function() {\n        //     //这里发送一个心跳，后端收到后，返回一个心跳消息，\n        //     //onmessage拿到返回的心跳就说明连接正常\n        //     self.socket.send(\"heartbeat...【\" + userId + \"】\");\n        //     self.serverTimeoutObj = setTimeout(function() { //如果超过一定时间还没重置，说明后端主动断开了\n        //         self.socket.close(); //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次\n        //     }, self.timeout)\n        // }, this.timeout)\n      }\n    };\n\n    this.socket.onopen = () => {\n      this.heartCheck.reset().start(); //心跳检测重置\n\n      console.log(\"Socket 已打开\");\n    };\n\n    this.socket.onmessage = msg => {\n      this.heartCheck.reset().start(); //心跳检测重置\n\n      if (msg.data.indexOf(\"{\") != -1) {\n        console.log(msg);\n        var obj = JSON.parse(msg.data);\n        this.state.chatList.push({\n          content: obj.content,\n          type: 'received',\n          time: getTimeHour(new Date().getTime())\n        });\n        this.setState({\n          index: this.state.index++\n        }); //console.log(obj);\n      }\n    };\n\n    this.socket.onerror = function (err) {\n      console.log(err);\n    };\n  }\n\n  getChatDetailList() {\n    getData({\n      method: 'post',\n      url: 'getChatDetailList',\n      data: {\n        chatId: this.item.chatId\n      },\n      successCB: res => {\n        let user = JSON.parse(localStorage.getItem(\"userInfo\"));\n        console.log(user);\n\n        if (res.code == 0) {\n          var list = res.result.list;\n          console.log(list);\n          list.map(item => {\n            if (item.userId != user.userId) {\n              item.type = \"received\";\n            }\n          });\n          console.log(list);\n          this.setState({\n            chatList: list\n          });\n        }\n\n        console.log(res);\n      }\n    });\n  }\n\n  onLeftClick() {\n    this.props.history.goBack();\n  }\n\n  openChat() {\n    this.setState({\n      isShow: true\n    });\n  }\n\n  sendMessage() {\n    var value = this.refs.textarea.value;\n\n    if (!value) {\n      return;\n    }\n\n    this.time = new Date().getTime();\n    this.state.chatList.push({\n      content: value,\n      time: getTimeHour(this.time)\n    });\n    this.setState({\n      isShow: false\n    }, () => {\n      self.refs.textarea.value = '';\n    });\n    var token = localStorage.getItem(\"token\");\n    var data = {\n      \"toUserId\": this.item.anotherUserId || this.item.publishUserId,\n      \"toUserName\": this.item.anotherUserName || this.item.publishUserName,\n      \"toUserAvatar\": this.item.anotherUserAvatar || this.item.publishUserAvatar,\n      \"token\": token,\n      \"content\": value\n    };\n    console.log(data);\n\n    if (this.socket.readyState === 1) {\n      this.socket.send(JSON.stringify(data));\n    } else {//do something\n    }\n  }\n\n  changeState(e) {\n    this.setState({\n      value: e.target.value\n    });\n  }\n\n  choseTime() {\n    var finalTime = getTimeHour(this.time);\n    console.log(new Date().getTime(), this.time + 1000 * 60);\n\n    if (new Date().getTime() > this.time + 1000 * 60) {\n      finalTime = getTimeHour(new Date().getTime());\n    } else {\n      if (this.count > 0) {\n        finalTime = '';\n      }\n    }\n\n    this.count++;\n    return finalTime;\n  }\n\n  render() {\n    console.log(this.state.chatList);\n    var productImgs = this.item.productImgs && this.item.productImgs.split(\",\");\n    var user = JSON.parse(localStorage.getItem(\"userInfo\")) || {};\n    return React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 183\n      },\n      __self: this\n    }, React.createElement(Title, {\n      title: this.item.anotherUserName || this.item.publishUserName,\n      onLeftClick: this.onLeftClick.bind(this),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 184\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      className: \"cm-bc-white\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 185\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-flex cm-jc-sb cm-p-018\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 186\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-flex cm-ai-c\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 187\n      },\n      __self: this\n    }, productImgs && productImgs[0] ? React.createElement(\"img\", {\n      src: productImgs[0],\n      alt: \"\",\n      className: \"cm-img-12 cm-mr-018\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 189\n      },\n      __self: this\n    }) : React.createElement(\"div\", {\n      className: \"cm-img-12 cm-mr-018 cm-c-999 cm-fs-026 cm-border-ddd cm-flex cm-ai-c cm-tx-c\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 190\n      },\n      __self: this\n    }, \"\\u8BE5\\u5546\\u54C1\\u5DF2\\u4E0B\\u67B6\"), React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 192\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-c-main cm-fs-024\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 193\n      },\n      __self: this\n    }, \"\\uFFE5123\"), React.createElement(\"div\", {\n      className: \"cm-c-999 cm-fs-020 cm-mt-018\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 194\n      },\n      __self: this\n    }, \"\\u4EA4\\u6613\\u524D\\u804A\\u4E00\\u804A\"))), productImgs && productImgs[0] ? React.createElement(\"div\", {\n      className: \"cm-btn-border-main cm-as-fe\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 198\n      },\n      __self: this\n    }, \"\\u7ACB\\u5373\\u8D2D\\u4E70\") : React.createElement(\"div\", {\n      className: \"cm-btn-border-gray cm-as-fe\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 199\n      },\n      __self: this\n    }, \"\\u7ACB\\u5373\\u8D2D\\u4E70\"))), React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 203\n      },\n      __self: this\n    }, this.state.chatList.map((item, index) => {\n      return React.createElement(\"div\", {\n        key: index,\n        className: \"cm-m-018\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 205\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-flex-column\",\n        key: index,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 206\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-tx-c cm-mtb-018\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 207\n        },\n        __self: this\n      }, item.time), item.type == \"received\" ? React.createElement(\"div\", {\n        className: \"cm-flex cm-ai-c cm-tx-c cm-as-fs detail-mr-30\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 208\n        },\n        __self: this\n      }, React.createElement(\"img\", {\n        src: this.item.anotherUserAvatar || this.item.publishUserAvatar,\n        alt: \"\",\n        className: \"cm-img-06 cm-as-fs\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 209\n        },\n        __self: this\n      }), React.createElement(\"div\", {\n        className: \"cm-flex\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 210\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"detail-triangle-right\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 211\n        },\n        __self: this\n      }), React.createElement(\"div\", {\n        className: \"detail-chat-height cm-pad-10 cm-bc-white cm-tx-l\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 212\n        },\n        __self: this\n      }, item.anotherContent || item.content))) : React.createElement(\"div\", {\n        className: \"cm-flex cm-ai-c cm-tx-c cm-as-fe detail-ml-30\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 215\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-flex\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 216\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \" detail-chat-height cm-pad-10 cm-bc-ddd cm-tx-l\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 217\n        },\n        __self: this\n      }, item.content), React.createElement(\"div\", {\n        className: \"detail-triangle\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 218\n        },\n        __self: this\n      })), React.createElement(\"img\", {\n        src: user.userAvatar,\n        alt: \"\",\n        className: \"cm-img-06 cm-as-fs\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 220\n        },\n        __self: this\n      }))));\n    })), React.createElement(\"div\", {\n      className: \"detail-position\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 227\n      },\n      __self: this\n    }, React.createElement(\"input\", {\n      type: \"text\",\n      placeholder: \"\\u60F3\\u8DDF\\u4ED6\\u8BF4\\u70B9\\u4EC0\\u4E48\\u5462\\uFF1F\",\n      className: \"msg-detail-textarea\",\n      onClick: e => this.openChat(e),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 228\n      },\n      __self: this\n    }), React.createElement(\"span\", {\n      className: \"detail-send\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 229\n      },\n      __self: this\n    }, \"\\u53D1\\u9001\")), this.state.isShow ? React.createElement(\"div\", {\n      className: \"detail-position\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 232\n      },\n      __self: this\n    }, React.createElement(\"textarea\", {\n      onChange: e => this.changeState(e),\n      ref: \"textarea\",\n      className: \"msg-detail-textarea\",\n      name: \"\",\n      id: \"\",\n      cols: \"30\",\n      rows: \"3\",\n      placeholder: \"\\u60F3\\u8DDF\\u4ED6\\u8BF4\\u70B9\\u4EC0\\u4E48\\u5462\\uFF1F\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 233\n      },\n      __self: this\n    }), React.createElement(\"span\", {\n      className: \"detail-send\",\n      onClick: () => this.sendMessage(),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 235\n      },\n      __self: this\n    }, \"\\u53D1\\u9001\")) : null);\n  }\n\n}","map":{"version":3,"sources":["C:\\Users\\caoxue\\Desktop\\secondary\\secondary\\src\\pages\\message\\messageDetail.js"],"names":["React","avatar","sale","buy","modify","Title","getData","goNext","getTimeFormat","getTimeHour","self","MessageDetail","Component","constructor","props","item","history","location","state","console","log","count","chatList","index","value","isShow","componentDidMount","getChatDetailList","textarea","document","getElementsByTagName","i","length","style","height","scrollTop","scrollHeight","addEventListener","e","target","user","JSON","parse","localStorage","getItem","userId","socket","WebSocket","heartCheck","timeout","timeoutObj","serverTimeoutObj","reset","clearTimeout","start","onopen","onmessage","msg","data","indexOf","obj","push","content","type","time","Date","getTime","setState","onerror","err","method","url","chatId","successCB","res","code","list","result","map","onLeftClick","goBack","openChat","sendMessage","refs","token","anotherUserId","publishUserId","anotherUserName","publishUserName","anotherUserAvatar","publishUserAvatar","readyState","send","stringify","changeState","choseTime","finalTime","render","productImgs","split","bind","anotherContent","userAvatar"],"mappings":"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","sourcesContent":["/**\r\n * Created by Lenovo on 2019/9/2.\r\n */\r\nimport React from 'react';\r\nimport './message.css';\r\nimport avatar from '../../images/personal/avatar.jpg';\r\nimport sale from '../../images/personal/sale.png';\r\nimport buy from '../../images/personal/buy.png';\r\nimport modify from '../../images/personal/modify.png';\r\nimport {Title} from '../../share';\r\nimport {getData, goNext, getTimeFormat, getTimeHour} from '../../utils';\r\nlet self;\r\nexport default class MessageDetail extends React.Component {\r\n    constructor(props) {\r\n        super(props);\r\n        this.item = this.props.history.location.state || {};\r\n        console.log(this.item);\r\n        self = this;\r\n        this.count = 0;\r\n        this.state = {\r\n            chatList: [],\r\n            index: 0,\r\n            value: null,\r\n            isShow:false\r\n        }\r\n        var item = this.props.history.location.state ||{};\r\n        this.item = item;\r\n        console.log(item);\r\n    }\r\n\r\n    componentDidMount() {\r\n        this.getChatDetailList();\r\n        var textarea = document.getElementsByTagName(\"textarea\");\r\n        for (var i = 0; i < textarea.length; i++) {\r\n            textarea[i].style.height = '0.5rem';\r\n            textarea[i].scrollTop = 0; //防抖动\r\n            textarea[i].style.height = textarea[i].scrollHeight + 'px';\r\n            textarea[i].addEventListener('input', function (e) {\r\n                e.target.style.height = 'auto';\r\n                e.target.scrollTop = 0; //防抖动\r\n                if (e.target.scrollHeight < 20) {\r\n                    e.target.style.height = '20px';\r\n                } else {\r\n                    e.target.style.height = e.target.scrollHeight + 'px';\r\n                }\r\n            })\r\n        }\r\n        var user = JSON.parse(localStorage.getItem(\"userInfo\")) || {};\r\n        var userId = user.userId;\r\n        console.log(user);\r\n        this.socket = new WebSocket(\"ws://49.232.24.206:9001/secondary/socket?\" + userId);\r\n        //心跳检测\r\n        this.heartCheck = {\r\n            timeout: 60000, //心跳间隔时间，单位ms\r\n            timeoutObj: null,\r\n            serverTimeoutObj: null,\r\n            reset: function() {\r\n                clearTimeout(this.timeoutObj);\r\n                clearTimeout(this.serverTimeoutObj);\r\n                return this;\r\n            },\r\n            start: function() {\r\n                // var self = this;\r\n                // this.timeoutObj = setTimeout(function() {\r\n                //     //这里发送一个心跳，后端收到后，返回一个心跳消息，\r\n                //     //onmessage拿到返回的心跳就说明连接正常\r\n                //     self.socket.send(\"heartbeat...【\" + userId + \"】\");\r\n                //     self.serverTimeoutObj = setTimeout(function() { //如果超过一定时间还没重置，说明后端主动断开了\r\n                //         self.socket.close(); //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次\r\n                //     }, self.timeout)\r\n                // }, this.timeout)\r\n            }\r\n        }\r\n        this.socket.onopen = ()=>{\r\n            this.heartCheck.reset().start(); //心跳检测重置\r\n            console.log(\"Socket 已打开\");\r\n        };\r\n        this.socket.onmessage =  (msg)=> {\r\n            this.heartCheck.reset().start(); //心跳检测重置\r\n            if (msg.data.indexOf(\"{\") != -1) {\r\n                console.log(msg);\r\n                var obj = JSON.parse(msg.data);\r\n                this.state.chatList.push({content: obj.content,type:'received',time: getTimeHour(new Date().getTime())});\r\n                this.setState({\r\n                    index: this.state.index++\r\n                })\r\n                //console.log(obj);\r\n            }\r\n        };\r\n        this.socket.onerror = function (err) {\r\n            console.log(err);\r\n        };\r\n    }\r\n\r\n    getChatDetailList() {\r\n        getData({\r\n            method: 'post',\r\n            url: 'getChatDetailList',\r\n            data: {\r\n                chatId:this.item.chatId\r\n            },\r\n            successCB: (res) => {\r\n                let user = JSON.parse(localStorage.getItem(\"userInfo\"));\r\n                console.log(user);\r\n                if(res.code == 0){\r\n                    var list = res.result.list;\r\n                    console.log(list);\r\n                    list.map((item)=>{\r\n                        if(item.userId != user.userId){\r\n                            item.type=\"received\";\r\n                        }\r\n                    });\r\n                    console.log(list);\r\n                    this.setState({\r\n                        chatList:list\r\n                    })\r\n                }\r\n                console.log(res);\r\n            }\r\n        })\r\n    }\r\n\r\n    onLeftClick() {\r\n        this.props.history.goBack();\r\n    }\r\n    openChat(){\r\n        this.setState({\r\n            isShow:true\r\n        })\r\n    }\r\n    sendMessage() {\r\n        var value = this.refs.textarea.value;\r\n        if (!value) {\r\n            return;\r\n        }\r\n        this.time = new Date().getTime();\r\n        this.state.chatList.push({content: value,time:getTimeHour(this.time)});\r\n        this.setState({\r\n            isShow: false\r\n        }, ()=>{\r\n            self.refs.textarea.value = '';\r\n        });\r\n        var token = localStorage.getItem(\"token\");\r\n        var data = {\r\n            \"toUserId\": this.item.anotherUserId||this.item.publishUserId,\r\n            \"toUserName\": this.item.anotherUserName||this.item.publishUserName,\r\n            \"toUserAvatar\": this.item.anotherUserAvatar||this.item.publishUserAvatar,\r\n            \"token\": token,\r\n            \"content\": value,\r\n        };\r\n        console.log(data)\r\n        if (this.socket.readyState === 1) {\r\n            this.socket.send(JSON.stringify(data));\r\n        } else {\r\n            //do something\r\n        }\r\n    }\r\n\r\n    changeState(e) {\r\n        this.setState({\r\n            value: e.target.value\r\n        })\r\n    }\r\n\r\n    choseTime() {\r\n        var finalTime = getTimeHour(this.time);\r\n        console.log((new Date().getTime()), (this.time + 1000 * 60));\r\n        if ((new Date().getTime()) > (this.time + 1000 * 60)) {\r\n            finalTime = getTimeHour(new Date().getTime())\r\n        } else {\r\n            if (this.count > 0) {\r\n                finalTime = '';\r\n            }\r\n        }\r\n        this.count++;\r\n        return finalTime;\r\n    }\r\n\r\n    render() {\r\n        console.log(this.state.chatList);\r\n        var productImgs = this.item.productImgs && this.item.productImgs.split(\",\");\r\n        var user = JSON.parse(localStorage.getItem(\"userInfo\")) || {};\r\n        return <div>\r\n            <Title title={this.item.anotherUserName||this.item.publishUserName} onLeftClick={this.onLeftClick.bind(this)}/>\r\n            <div className=\"cm-bc-white\">\r\n            <div className=\"cm-flex cm-jc-sb cm-p-018\">\r\n            <div className=\"cm-flex cm-ai-c\">\r\n                {productImgs && productImgs[0]?\r\n                    <img src={productImgs[0]} alt=\"\" className=\"cm-img-12 cm-mr-018\"/>:\r\n                    <div className=\"cm-img-12 cm-mr-018 cm-c-999 cm-fs-026 cm-border-ddd cm-flex cm-ai-c cm-tx-c\">该商品已下架</div>\r\n                }\r\n                <div>\r\n                    <div className=\"cm-c-main cm-fs-024\">￥123</div>\r\n                    <div className=\"cm-c-999 cm-fs-020 cm-mt-018\">交易前聊一聊</div>\r\n                </div>\r\n            </div>\r\n                {productImgs && productImgs[0]?\r\n                <div className=\"cm-btn-border-main cm-as-fe\">立即购买</div>:\r\n                    <div className=\"cm-btn-border-gray cm-as-fe\">立即购买</div>\r\n                }\r\n            </div>\r\n            </div>\r\n            <div>\r\n            {this.state.chatList.map((item, index) => {\r\n                return <div key={index} className=\"cm-m-018\">\r\n                    <div className=\"cm-flex-column\" key={index}>\r\n                        <div className=\"cm-tx-c cm-mtb-018\">{item.time}</div>\r\n                        {item.type == \"received\"? <div className=\"cm-flex cm-ai-c cm-tx-c cm-as-fs detail-mr-30\">\r\n                                <img src={this.item.anotherUserAvatar||this.item.publishUserAvatar} alt=\"\" className=\"cm-img-06 cm-as-fs\"/>\r\n                                <div className=\"cm-flex\">\r\n                                    <div className=\"detail-triangle-right\"></div>\r\n                                    <div className=\"detail-chat-height cm-pad-10 cm-bc-white cm-tx-l\">{item.anotherContent||item.content}</div>\r\n                                </div>\r\n                            </div>:\r\n                            <div className=\"cm-flex cm-ai-c cm-tx-c cm-as-fe detail-ml-30\">\r\n                                <div className=\"cm-flex\">\r\n                                    <div className=\" detail-chat-height cm-pad-10 cm-bc-ddd cm-tx-l\">{item.content}</div>\r\n                                    <div className=\"detail-triangle\"></div>\r\n                                </div>\r\n                                <img src={user.userAvatar} alt=\"\" className=\"cm-img-06 cm-as-fs\"/>\r\n                            </div>\r\n                        }\r\n                    </div>\r\n                </div>\r\n            })}\r\n            </div>\r\n            <div className=\"detail-position\">\r\n                <input type=\"text\" placeholder=\"想跟他说点什么呢？\" className=\"msg-detail-textarea\" onClick={(e) => this.openChat(e)}/>\r\n                <span className=\"detail-send\">发送</span>\r\n            </div>\r\n            {this.state.isShow?\r\n            <div className=\"detail-position\">\r\n                <textarea onChange={(e) => this.changeState(e)} ref=\"textarea\" className=\"msg-detail-textarea\" name=\"\"\r\n                          id=\"\" cols=\"30\" rows=\"3\" placeholder=\"想跟他说点什么呢？\"></textarea>\r\n                <span className=\"detail-send\"\r\n                      onClick={() => this.sendMessage()}>发送</span>\r\n            </div>:null}\r\n        </div>\r\n    }\r\n}"]},"metadata":{},"sourceType":"module"}