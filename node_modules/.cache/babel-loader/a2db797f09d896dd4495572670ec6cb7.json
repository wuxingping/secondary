{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\caoxue\\\\Desktop\\\\secondary\\\\src\\\\pages\\\\message\\\\messageDetail\\\\messageDetail.js\";\n\n/**\r\n * Created by Lenovo on 2019/9/2.\r\n */\nimport React from 'react';\nimport { Title } from '../../../share';\nimport ReactDOM from 'react-dom';\nimport { getData, getTimeFormat, getTimeHour, autoTextarea, goNext } from '../../../utils';\nimport sendErr from '../../../images/message/sendErr.png';\nimport './messageDetail.css';\nlet self;\nexport default class MessageDetail extends React.Component {\n  constructor(props) {\n    super(props); //获取从聊天列表页面和商品详情页传过来的参数\n\n    this.item = this.props.history.location.state || {}; //获取本地缓存的个人信息\n\n    this.user = localStorage.getItem(\"userInfo\") ? JSON.parse(localStorage.getItem(\"userInfo\")) : {}; //初始化聊天记录数据源\n    // const dataSource = new ListView.DataSource({\n    //     rowHasChanged: (row1, row2) => row1 !== row2,\n    // });\n\n    self = this;\n    this.state = {\n      dataSource: [],\n      hasMore: true,\n      pageNum: 1,\n      //定义初始化请求序号\n      pageSize: 10,\n      //定义初始化请求数量\n      value: \"\",\n      loadingText: \"\",\n      isSendErr: false\n    };\n    this.initData = [];\n  }\n\n  componentDidMount() {\n    setTimeout(() => {\n      autoTextarea();\n      var topHeight = this.refs.topHeight;\n      var scroll = ReactDOM.findDOMNode(this.lv);\n      const hei = window.innerHeight - 50 - topHeight.offsetHeight + \"px\";\n      scroll.style.height = hei;\n      var scrollHeight = scroll.scrollHeight;\n      scroll.scrollTop = scrollHeight;\n      scroll.addEventListener('scroll', e => {\n        if (!this.state.hasMore) {\n          return;\n        }\n\n        setTimeout(() => {\n          if (e.target.scrollTop == 0) {\n            e.target.scrollTop = 10;\n            setTimeout(() => {\n              e.target.scrollTo(0, scrollHeight - 30);\n            }, 100);\n            this.getChatDetailList((list, total) => {\n              if (total === 0) {\n                this.setState({\n                  loadingText: \"暂无消息\" //总数为0时表示没有数据\n\n                });\n              } else if (list.length >= total) {\n                this.setState({\n                  dataSource: list,\n                  hasMore: false,\n                  loadingText: \"没有更多记录了\"\n                });\n              } else {\n                this.setState({\n                  dataSource: list,\n                  loadingText: \"加载中...\"\n                });\n              }\n            });\n          }\n        }, 2000);\n      });\n    }, 200);\n    this.getChatDetailList();\n    this.socket = new WebSocket(\"ws://49.232.24.206:9001/secondary/socket?\" + this.user.userId); //心跳检测\n\n    this.heartCheck = {\n      timeout: 60000,\n      //心跳间隔时间，单位ms\n      timeoutObj: null,\n      serverTimeoutObj: null,\n      reset: function () {\n        clearTimeout(this.timeoutObj);\n        clearTimeout(this.serverTimeoutObj);\n        return this;\n      },\n      start: function () {\n        var that = this;\n        this.timeoutObj = setTimeout(function () {\n          //这里发送一个心跳，后端收到后，返回一个心跳消息，\n          //onmessage拿到返回的心跳就说明连接正常\n          self.socket.send(\"heartbeat...【\" + self.user.userId + \"】\");\n          that.serverTimeoutObj = setTimeout(function () {\n            //如果超过一定时间还没重置，说明后端主动断开了\n            self.socket.close(); //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次\n          }, that.timeout);\n        }, this.timeout);\n      }\n    };\n\n    this.socket.onopen = () => {\n      this.heartCheck.reset().start(); //心跳检测重置\n    };\n\n    this.socket.onmessage = msg => {\n      this.heartCheck.reset().start(); //心跳检测重置\n\n      if (msg.data.indexOf(\"{\") !== -1) {\n        var obj = JSON.parse(msg.data);\n        this.initData.push({\n          content: obj.content,\n          type: 'received',\n          time: getTimeHour(new Date().getTime())\n        });\n        this.setState({\n          dataSource: this.initData\n        });\n      }\n    };\n\n    this.socket.onerror = function (err) {\n      console.log(err);\n    };\n  }\n\n  getChatDetailList(cb) {\n    getData({\n      method: 'post',\n      url: 'getChatDetailList',\n      data: {\n        chatId: this.item.chatId,\n        pageNum: this.state.pageNum,\n        pageSize: this.state.pageSize\n      },\n      successCB: res => {\n        var list = res.result.list;\n        list.map(item => {\n          if (item.userId !== this.user.userId) {\n            item.type = \"received\";\n          } //今天的时间用09:30格式，今天之前的用2019-02-02 09:30格式\n\n\n          var nowTime = new Date().getTime();\n          var tomorrow = nowTime - 12 * 60 * 60 * 1000;\n\n          if (item.createTime < tomorrow) {\n            item.time = getTimeFormat(item.createTime);\n          } else {\n            item.time = getTimeHour(item.createTime);\n          }\n        }); //反转数组，将最早的时间排在最下面\n\n        list = list.reverse();\n        this.initData = list.concat(this.initData); //已有的数组拼接上拉加载更多的数组\n\n        let total = res.result.total; //商品列表总数量\n\n        if (cb) {\n          cb(this.initData, total);\n        }\n\n        this.state.pageNum++;\n      }\n    });\n  }\n\n  sendMessage(e) {\n    //阻止冒泡事件\n    e.stopPropagation(); //发送完成之后将消息区域滑到底部，输入框内容清空并聚焦\n\n    setTimeout(() => {\n      ReactDOM.findDOMNode(this.lv).scrollTop = ReactDOM.findDOMNode(this.lv).scrollHeight;\n      this.refs.textarea.value = \"\";\n    }, 500); //输入框聚焦，弹起键盘\n\n    this.refs.textarea.focus(); //如果没有输入值，直接返回\n\n    var value = this.refs.textarea.value;\n\n    if (!value) {\n      return;\n    }\n\n    this.time = new Date().getTime();\n    this.initData.push({\n      content: value,\n      time: getTimeHour(this.time)\n    });\n    this.setState({\n      dataSource: this.initData\n    });\n    var token = localStorage.getItem(\"token\");\n    var data = {\n      \"toUserId\": this.item.anotherUserId || this.item.publishUserId,\n      \"toUserName\": this.item.anotherUserName || this.item.publishUserName,\n      \"toUserAvatar\": this.item.anotherUserAvatar || this.item.publishUserAvatar,\n      \"chatId\": this.item.chatId,\n      \"token\": token,\n      \"content\": value\n    };\n\n    if (this.socket.readyState === 1) {\n      this.socket.send(JSON.stringify(data));\n    } else {} //do something\n    //通讯发生错误时触发,发送错误时消息前面有提示图标\n\n\n    this.socket.onerror = function () {\n      this.setState({\n        isSendErr: true\n      });\n    };\n  }\n\n  changeState(e) {\n    this.setState({\n      value: e.target.value\n    });\n  }\n\n  close() {\n    //当滑动滚动区域时，收起键盘，将高度改回来\n    this.refs.textarea.blur();\n    this.refs.textarea.value = \"\";\n    this.refs.textarea.height = \"0.6rem\";\n  } //点击立即购买，跳转到购买页\n\n\n  order(e) {\n    e.stopPropagation();\n    getData({\n      method: 'post',\n      url: 'placeOrder',\n      data: {\n        productId: this.item.productId\n      },\n      successCB: res => {\n        this.item.orderId = res.result.orderId;\n        goNext(this, 'order', this.item);\n      }\n    });\n  }\n\n  render() {\n    var productImgs = this.item.productImgs && this.item.productImgs.split(\",\");\n    return React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 221\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      ref: \"topHeight\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 222\n      },\n      __self: this\n    }, React.createElement(Title, {\n      title: this.item.anotherUserName || this.item.publishUserName,\n      that: this,\n      style: {\n        background: \"#fff\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 223\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      className: \"cm-flex cm-jc-sb cm-p-02  cm-bc-white detail-fixed\",\n      onClick: () => productImgs && productImgs[0] ? goNext(this, \"productDetail\", this.item) : undefined,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 227\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-flex cm-ai-c\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 229\n      },\n      __self: this\n    }, productImgs && productImgs[0] ? React.createElement(\"img\", {\n      src: productImgs[0],\n      alt: \"\",\n      className: \"cm-img-10 cm-mr-02\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 231\n      },\n      __self: this\n    }) : React.createElement(\"div\", {\n      className: \"cm-img-10 cm-mr-02 cm-c-999 cm-fs-026 cm-border-ddd cm-flex cm-ai-c cm-tx-c\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 232\n      },\n      __self: this\n    }, \"\\u8BE5\\u5546\\u54C1\\u5DF2\\u4E0B\\u67B6\"), React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 234\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-c-main cm-fs-028 cm-fw-bold\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 235\n      },\n      __self: this\n    }, \"\\uFFE5\", this.item.productPrice ? this.item.productPrice : \"0.00\"), React.createElement(\"div\", {\n      className: \"cm-c-999 cm-fs-026 cm-mt-01\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 236\n      },\n      __self: this\n    }, \"\\u4EA4\\u6613\\u524D\\u804A\\u4E00\\u804A\"))), React.createElement(\"div\", {\n      className: (productImgs && productImgs[0] ? \"cm-btn-border-main\" : \"cm-btn-border-999\") + \" cm-as-fe\",\n      onClick: e => productImgs && productImgs[0] ? this.order(e) : undefined,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 239\n      },\n      __self: this\n    }, \"\\u7ACB\\u5373\\u8D2D\\u4E70\"))), React.createElement(\"div\", {\n      ref: el => this.lv = el,\n      onTouchStart: () => this.close(),\n      style: {\n        overflow: \"auto\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 243\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      style: {\n        height: \"40px\",\n        lineHeight: \"40px\"\n      },\n      className: \"cm-tx-c cm-tx-c cm-c-999\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 246\n      },\n      __self: this\n    }, this.state.loadingText), this.state.dataSource.map((item, rowID) => {\n      return React.createElement(\"div\", {\n        key: rowID,\n        className: \"cm-p-030\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 249\n        },\n        __self: this\n      }, item.type === \"received\" ? React.createElement(\"div\", {\n        className: \"cm-tx-c\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 251\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-mtb-02\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 252\n        },\n        __self: this\n      }, React.createElement(\"span\", {\n        className: \"cm-p-006 cm-border-radius-10 cm-bc-ddd cm-c-white cm-fs-024\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 253\n        },\n        __self: this\n      }, item.time)), React.createElement(\"div\", {\n        className: \"cm-flex cm-ai-c cm-jc-fs\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 255\n        },\n        __self: this\n      }, React.createElement(\"img\", {\n        src: this.item.anotherUserAvatar || this.item.publishUserAvatar,\n        alt: \"\",\n        className: \"cm-img-06 cm-as-fs\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 256\n        },\n        __self: this\n      }), React.createElement(\"div\", {\n        className: \"cm-flex cm-flex-1\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 257\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"detail-triangle-right\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 258\n        },\n        __self: this\n      }), React.createElement(\"div\", {\n        className: \"detail-chat-height cm-bc-white cm-tx-l detail-mr-06\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 259\n        },\n        __self: this\n      }, item.anotherContent || item.content)))) : React.createElement(\"div\", {\n        className: \"cm-tx-c\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 264\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-mtb-02\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 265\n        },\n        __self: this\n      }, React.createElement(\"span\", {\n        className: \"cm-p-006 cm-border-radius-10 cm-bc-ddd cm-c-white cm-fs-024\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 266\n        },\n        __self: this\n      }, item.time)), React.createElement(\"div\", {\n        className: \"cm-flex cm-ai-c cm-jc-fe detail-ml-06\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 268\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"cm-flex cm-flex-1 cm-jc-fe cm-ai-c\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 269\n        },\n        __self: this\n      }, this.state.isSendErr ? React.createElement(\"img\", {\n        src: sendErr,\n        alt: \"\",\n        className: \"cm-img-04\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 270\n        },\n        __self: this\n      }) : null, React.createElement(\"div\", {\n        className: \" detail-chat-height cm-bc-main-transparent cm-c-white cm-tx-l\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 271\n        },\n        __self: this\n      }, item.content), React.createElement(\"div\", {\n        className: \"detail-triangle\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 272\n        },\n        __self: this\n      })), React.createElement(\"img\", {\n        src: this.user.userAvatar,\n        alt: \"\",\n        className: \"cm-img-06 cm-as-fs\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 274\n        },\n        __self: this\n      }))));\n    })), React.createElement(\"div\", {\n      className: \"detail-bottom-height\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 283\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      className: \"cm-bottom-position cm-bc-white\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 284\n      },\n      __self: this\n    }, React.createElement(\"textarea\", {\n      onChange: e => this.changeState(e),\n      ref: \"textarea\",\n      className: \"cm-border-ddd cm-border-radius-10 cm-mr-02 cm-flex-1 cm-p-02\",\n      name: \"\",\n      id: \"\",\n      cols: \"30\",\n      rows: \"1\",\n      placeholder: \"\\u60F3\\u8DDF\\u4ED6\\u8BF4\\u70B9\\u4EC0\\u4E48\\u5462\\uFF1F\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 285\n      },\n      __self: this\n    }), React.createElement(\"span\", {\n      className: \"cm-btn-main-higher cm-as-fe\",\n      onClick: e => this.sendMessage(e),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 289\n      },\n      __self: this\n    }, \"\\u53D1\\u9001\"))));\n  }\n\n}","map":{"version":3,"sources":["C:\\Users\\caoxue\\Desktop\\secondary\\src\\pages\\message\\messageDetail\\messageDetail.js"],"names":["React","Title","ReactDOM","getData","getTimeFormat","getTimeHour","autoTextarea","goNext","sendErr","self","MessageDetail","Component","constructor","props","item","history","location","state","user","localStorage","getItem","JSON","parse","dataSource","hasMore","pageNum","pageSize","value","loadingText","isSendErr","initData","componentDidMount","setTimeout","topHeight","refs","scroll","findDOMNode","lv","hei","window","innerHeight","offsetHeight","style","height","scrollHeight","scrollTop","addEventListener","e","target","scrollTo","getChatDetailList","list","total","setState","length","socket","WebSocket","userId","heartCheck","timeout","timeoutObj","serverTimeoutObj","reset","clearTimeout","start","that","send","close","onopen","onmessage","msg","data","indexOf","obj","push","content","type","time","Date","getTime","onerror","err","console","log","cb","method","url","chatId","successCB","res","result","map","nowTime","tomorrow","createTime","reverse","concat","sendMessage","stopPropagation","textarea","focus","token","anotherUserId","publishUserId","anotherUserName","publishUserName","anotherUserAvatar","publishUserAvatar","readyState","stringify","changeState","blur","order","productId","orderId","render","productImgs","split","background","undefined","productPrice","el","overflow","lineHeight","rowID","anotherContent","userAvatar"],"mappings":"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","sourcesContent":["/**\r\n * Created by Lenovo on 2019/9/2.\r\n */\r\nimport React from 'react';\r\nimport {Title} from '../../../share';\r\nimport ReactDOM from 'react-dom';\r\nimport {getData,getTimeFormat, getTimeHour,autoTextarea,goNext} from '../../../utils';\r\nimport sendErr from '../../../images/message/sendErr.png';\r\nimport './messageDetail.css';\r\nlet self;\r\nexport default class MessageDetail extends React.Component {\r\n    constructor(props) {\r\n        super(props);\r\n        //获取从聊天列表页面和商品详情页传过来的参数\r\n        this.item = this.props.history.location.state || {};\r\n        //获取本地缓存的个人信息\r\n        this.user = localStorage.getItem(\"userInfo\")?JSON.parse(localStorage.getItem(\"userInfo\")):{};\r\n        //初始化聊天记录数据源\r\n        // const dataSource = new ListView.DataSource({\r\n        //     rowHasChanged: (row1, row2) => row1 !== row2,\r\n        // });\r\n        self = this;\r\n        this.state = {\r\n            dataSource:[],\r\n            hasMore:true,\r\n            pageNum:1,//定义初始化请求序号\r\n            pageSize:10,//定义初始化请求数量\r\n            value: \"\",\r\n            loadingText:\"\",\r\n            isSendErr:false\r\n        };\r\n        this.initData = [];\r\n    }\r\n\r\n    componentDidMount() {\r\n        setTimeout(()=>{\r\n                autoTextarea();\r\n                var topHeight = this.refs.topHeight;\r\n                var scroll = ReactDOM.findDOMNode(this.lv);\r\n                const hei = window.innerHeight-50-topHeight.offsetHeight+\"px\";\r\n                scroll.style.height = hei;\r\n                var scrollHeight = scroll.scrollHeight;\r\n                scroll.scrollTop = scrollHeight;\r\n                    scroll.addEventListener('scroll',(e)=>{\r\n                        if(!this.state.hasMore){\r\n                            return;\r\n                        }\r\n                        setTimeout(()=>{\r\n                        if(e.target.scrollTop == 0 ){\r\n                            e.target.scrollTop = 10;\r\n                            setTimeout(()=>{\r\n                                e.target.scrollTo(0,scrollHeight-30);\r\n                            },100);\r\n                            this.getChatDetailList((list,total)=>{\r\n                                if(total === 0){\r\n                                    this.setState({\r\n                                        loadingText:\"暂无消息\"//总数为0时表示没有数据\r\n                                    })\r\n                                }else if(list.length>=total){\r\n                                    this.setState({\r\n                                        dataSource: list,\r\n                                        hasMore:false,\r\n                                        loadingText:\"没有更多记录了\"\r\n                                    })\r\n                                }else {\r\n                                    this.setState({\r\n                                        dataSource: list,\r\n                                        loadingText:\"加载中...\"\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n                        },2000)\r\n                    })\r\n        },200);\r\n        this.getChatDetailList();\r\n        this.socket = new WebSocket(\"ws://49.232.24.206:9001/secondary/socket?\" + this.user.userId);\r\n        //心跳检测\r\n        this.heartCheck = {\r\n            timeout: 60000, //心跳间隔时间，单位ms\r\n            timeoutObj: null,\r\n            serverTimeoutObj: null,\r\n            reset: function() {\r\n                clearTimeout(this.timeoutObj);\r\n                clearTimeout(this.serverTimeoutObj);\r\n                return this;\r\n            },\r\n            start: function() {\r\n                var that = this;\r\n                this.timeoutObj = setTimeout(function() {\r\n                    //这里发送一个心跳，后端收到后，返回一个心跳消息，\r\n                    //onmessage拿到返回的心跳就说明连接正常\r\n                    self.socket.send(\"heartbeat...【\" + self.user.userId + \"】\");\r\n                    that.serverTimeoutObj = setTimeout(function() { //如果超过一定时间还没重置，说明后端主动断开了\r\n                        self.socket.close(); //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次\r\n                    }, that.timeout)\r\n                }, this.timeout)\r\n            }\r\n        }\r\n        this.socket.onopen = ()=>{\r\n            this.heartCheck.reset().start(); //心跳检测重置\r\n        };\r\n        this.socket.onmessage = (msg)=> {\r\n            this.heartCheck.reset().start(); //心跳检测重置\r\n            if (msg.data.indexOf(\"{\") !== -1) {\r\n                var obj = JSON.parse(msg.data);\r\n                this.initData.push({content: obj.content,type:'received',time: getTimeHour(new Date().getTime())});\r\n                this.setState({\r\n                    dataSource: this.initData,\r\n                })\r\n            }\r\n        };\r\n        this.socket.onerror = function (err) {\r\n            console.log(err);\r\n        };\r\n    }\r\n    getChatDetailList(cb) {\r\n        getData({\r\n            method: 'post',\r\n            url: 'getChatDetailList',\r\n            data: {\r\n                chatId:this.item.chatId,\r\n                pageNum:this.state.pageNum,\r\n                pageSize:this.state.pageSize,\r\n            },\r\n            successCB: (res) => {\r\n                var list = res.result.list;\r\n                list.map((item)=>{\r\n                    if(item.userId !== this.user.userId){\r\n                        item.type=\"received\";\r\n                    }\r\n                    //今天的时间用09:30格式，今天之前的用2019-02-02 09:30格式\r\n                    var nowTime = (new Date()).getTime();\r\n                    var tomorrow = nowTime - 12*60*60*1000;\r\n                    if(item.createTime<tomorrow){\r\n                        item.time = getTimeFormat(item.createTime);\r\n                    }else {\r\n                        item.time = getTimeHour(item.createTime)\r\n                    }\r\n                });\r\n                //反转数组，将最早的时间排在最下面\r\n                list = list.reverse();\r\n                this.initData = list.concat(this.initData);//已有的数组拼接上拉加载更多的数组\r\n                let total = res.result.total;//商品列表总数量\r\n                if(cb){\r\n                    cb(this.initData,total);\r\n                }\r\n                this.state.pageNum++;\r\n            }\r\n        })\r\n    }\r\n    sendMessage(e) {\r\n        //阻止冒泡事件\r\n        e.stopPropagation();\r\n        //发送完成之后将消息区域滑到底部，输入框内容清空并聚焦\r\n        setTimeout(()=>{\r\n            ReactDOM.findDOMNode(this.lv).scrollTop = ReactDOM.findDOMNode(this.lv).scrollHeight;\r\n            this.refs.textarea.value = \"\";\r\n        },500);\r\n        //输入框聚焦，弹起键盘\r\n        this.refs.textarea.focus();\r\n        //如果没有输入值，直接返回\r\n        var value = this.refs.textarea.value;\r\n        if (!value) {\r\n            return;\r\n        }\r\n        this.time = new Date().getTime();\r\n        this.initData.push({content: value,time:getTimeHour(this.time)});\r\n        this.setState({\r\n            dataSource: this.initData,\r\n        });\r\n        var token = localStorage.getItem(\"token\");\r\n        var data = {\r\n            \"toUserId\": this.item.anotherUserId||this.item.publishUserId,\r\n            \"toUserName\": this.item.anotherUserName||this.item.publishUserName,\r\n            \"toUserAvatar\": this.item.anotherUserAvatar||this.item.publishUserAvatar,\r\n            \"chatId\":this.item.chatId,\r\n            \"token\": token,\r\n            \"content\": value,\r\n        };\r\n        if (this.socket.readyState === 1) {\r\n            this.socket.send(JSON.stringify(data));\r\n        } else {\r\n            //do something\r\n        }\r\n        //通讯发生错误时触发,发送错误时消息前面有提示图标\r\n        this.socket.onerror = function () {\r\n            this.setState({\r\n                isSendErr:true\r\n            })\r\n        }\r\n    }\r\n    changeState(e) {\r\n        this.setState({\r\n            value: e.target.value\r\n        })\r\n    }\r\n    close(){\r\n        //当滑动滚动区域时，收起键盘，将高度改回来\r\n        this.refs.textarea.blur();\r\n        this.refs.textarea.value = \"\";\r\n        this.refs.textarea.height=\"0.6rem\";\r\n    }\r\n    //点击立即购买，跳转到购买页\r\n    order(e){\r\n        e.stopPropagation();\r\n        getData({\r\n            method: 'post',\r\n            url: 'placeOrder',\r\n            data: {\r\n                productId:this.item.productId,\r\n            },\r\n            successCB: (res) => {\r\n                this.item.orderId = res.result.orderId;\r\n                goNext(this,'order',this.item);\r\n            }\r\n        })\r\n    }\r\n    render() {\r\n        var productImgs = this.item.productImgs && this.item.productImgs.split(\",\");\r\n        return <div>\r\n            <div ref=\"topHeight\">\r\n            <Title title={this.item.anotherUserName||this.item.publishUserName}\r\n                   that={this}\r\n                   style={{background:\"#fff\"}}\r\n            />\r\n            <div className=\"cm-flex cm-jc-sb cm-p-02  cm-bc-white detail-fixed\"\r\n                 onClick={()=>productImgs && productImgs[0]?goNext(this,\"productDetail\",this.item):undefined}>\r\n            <div className=\"cm-flex cm-ai-c\">\r\n                {productImgs && productImgs[0]?\r\n                    <img src={productImgs[0]} alt=\"\" className=\"cm-img-10 cm-mr-02\"/>:\r\n                    <div className=\"cm-img-10 cm-mr-02 cm-c-999 cm-fs-026 cm-border-ddd cm-flex cm-ai-c cm-tx-c\">该商品已下架</div>\r\n                }\r\n                <div>\r\n                    <div className=\"cm-c-main cm-fs-028 cm-fw-bold\">￥{this.item.productPrice?this.item.productPrice:\"0.00\"}</div>\r\n                    <div className=\"cm-c-999 cm-fs-026 cm-mt-01\">交易前聊一聊</div>\r\n                </div>\r\n            </div>\r\n            <div className={(productImgs && productImgs[0]?\"cm-btn-border-main\":\"cm-btn-border-999\")+\" cm-as-fe\"}\r\n                 onClick={(e)=>productImgs && productImgs[0]?this.order(e):undefined}>立即购买</div>\r\n            </div>\r\n            </div>\r\n            <div ref={(el)=>this.lv=el} onTouchStart={()=>this.close()}\r\n                 style={{overflow:\"auto\"}}\r\n            >\r\n                {<div style={{height:\"40px\",lineHeight:\"40px\"}} className=\"cm-tx-c cm-tx-c cm-c-999\">{this.state.loadingText}</div>}\r\n                {this.state.dataSource.map((item,rowID)=>{\r\n                    return(\r\n                        <div key={rowID} className=\"cm-p-030\">\r\n                            {item.type === \"received\"?\r\n                                <div className=\"cm-tx-c\">\r\n                                    <div className=\"cm-mtb-02\">\r\n                                        <span className=\"cm-p-006 cm-border-radius-10 cm-bc-ddd cm-c-white cm-fs-024\">{item.time}</span>\r\n                                    </div>\r\n                                    <div className=\"cm-flex cm-ai-c cm-jc-fs\">\r\n                                        <img src={this.item.anotherUserAvatar||this.item.publishUserAvatar} alt=\"\" className=\"cm-img-06 cm-as-fs\"/>\r\n                                        <div className=\"cm-flex cm-flex-1\">\r\n                                            <div className=\"detail-triangle-right\"></div>\r\n                                            <div className=\"detail-chat-height cm-bc-white cm-tx-l detail-mr-06\">{item.anotherContent||item.content}</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                :\r\n                                <div className=\"cm-tx-c\">\r\n                                    <div className=\"cm-mtb-02\">\r\n                                        <span className=\"cm-p-006 cm-border-radius-10 cm-bc-ddd cm-c-white cm-fs-024\">{item.time}</span>\r\n                                    </div>\r\n                                    <div className=\"cm-flex cm-ai-c cm-jc-fe detail-ml-06\">\r\n                                        <div className=\"cm-flex cm-flex-1 cm-jc-fe cm-ai-c\">\r\n                                            {this.state.isSendErr?<img src={sendErr} alt=\"\" className=\"cm-img-04\"/>:null}\r\n                                            <div className=\" detail-chat-height cm-bc-main-transparent cm-c-white cm-tx-l\">{item.content}</div>\r\n                                            <div className=\"detail-triangle\"></div>\r\n                                        </div>\r\n                                        <img src={this.user.userAvatar} alt=\"\" className=\"cm-img-06 cm-as-fs\"/>\r\n                                    </div>\r\n                                </div>\r\n                            }\r\n                        </div>                        \r\n                    )\r\n                    \r\n                })}\r\n            </div>\r\n            <div className=\"detail-bottom-height\">\r\n            <div className=\"cm-bottom-position cm-bc-white\">\r\n                <textarea onChange={(e) => this.changeState(e)}\r\n                              ref=\"textarea\"\r\n                              className=\"cm-border-ddd cm-border-radius-10 cm-mr-02 cm-flex-1 cm-p-02\" name=\"\"\r\n                              id=\"\" cols=\"30\" rows=\"1\" placeholder=\"想跟他说点什么呢？\"></textarea>\r\n                <span className=\"cm-btn-main-higher cm-as-fe\"\r\n                      onClick={(e) => this.sendMessage(e)}>发送</span>\r\n            </div>\r\n            </div>\r\n        </div>\r\n    }\r\n}"]},"metadata":{},"sourceType":"module"}